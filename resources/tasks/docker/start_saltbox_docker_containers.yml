##########################################################################################
# Title:         Saltbox: Resources | Tasks | Docker | Start Saltbox Docker Containers   #
# Author(s):     salty                                                                   #
# URL:           https://github.com/saltyorg/Saltbox                                     #
# --                                                                                     #
##########################################################################################
#                   GNU General Public License v3.0                                      #
##########################################################################################
---
- name: "Resources | Tasks | Docker | Start Saltbox Docker Containers | Populate Service Facts"
  ansible.builtin.service_facts:

- name: "Resources | Tasks | Docker | Start Saltbox Docker Containers | Get Docker service state"
  ansible.builtin.set_fact:
    start_docker_service_running: "{{ (services['docker.service'] is defined) and (services['docker.service']['state'] == 'running') }}"
    start_docker_containers_docker_controller_service_running: "{{ (services['saltbox_managed_docker_controller.service'] is defined) and (services['saltbox_managed_docker_controller.service']['state'] == 'running') }}"

- name: Resources | Tasks | Docker | Start Saltbox Docker Containers | Run Controller Tasks
  when: start_docker_service_running and start_docker_containers_docker_controller_service_running
  block:
    - name: Resources | Tasks | Docker | Start Saltbox Docker Containers | Unblock Docker Controller
      ansible.builtin.uri:
        url: "{{ docker_controller_url }}/unblock"
        method: POST
        timeout: 600
      when: start_docker_containers_docker_controller_service_running

    - name: Resources | Tasks | Docker | Start Saltbox Docker Containers | Start Saltbox Docker Containers
      ansible.builtin.uri:
        url: "{{ docker_controller_url }}/start{{ _query_var if _query_var is defined else '' }}"
        method: POST
      register: start_docker_controller_job
      ignore_errors: true

    - name: Resources | Tasks | Docker | Start Saltbox Docker Containers | Poll for job completion
      ansible.builtin.uri:
        url: "{{ docker_controller_url }}/job_status/{{ start_docker_controller_job.json.job_id }}"
        method: GET
      register: start_job_status
      until: (start_job_status.json.status in ['completed', 'failed'])
      retries: 120
      delay: 5
      when:
        - (start_docker_controller_job is success)
        - (start_docker_controller_job.json.job_id is defined)
      ignore_errors: true

    - name: Resources | Tasks | Docker | Start Saltbox Docker Containers | Check job status
      ansible.builtin.debug:
        msg: "Status of starting Saltbox Docker containers: {{ start_job_status.json.status | default('unknown') }}"
      when:
        - (start_docker_controller_job is success)
        - (start_docker_controller_job.json.job_id is defined)

    - name: Resources | Tasks | Docker | Start Saltbox Docker Containers | Check operation status (legacy)
      ansible.builtin.debug:
        msg: "Status of starting Saltbox Docker containers: {{ start_docker_controller_job.json.message | default('unknown') }}"
      when:
        - (start_docker_controller_job is success)
        - (start_docker_controller_job.json.job_id is not defined)

    - name: Resources | Tasks | Docker | Start Saltbox Docker Containers | Check for operation failure
      ansible.builtin.debug:
        msg: "Failed to start Saltbox Docker containers"
      when: (start_docker_controller_job is failed)
