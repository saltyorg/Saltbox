#########################################################################
# Title:         Saltbox: PostgreSQL Role                               #
# Author(s):     salty                                                  #
# URL:           https://github.com/saltyorg/Saltbox                    #
# --                                                                    #
#########################################################################
#                   GNU General Public License v3.0                     #
#########################################################################
---
- name: Initialize variables
  ansible.builtin.set_fact:
    postgres_major_version: ""
    postgres_docker_tag_major_version: ""
    postgres_original_image_repo: "{{ true if lookup('role_var', '_docker_image_repo', role='postgres') == 'postgres' else false }}"

- name: Supported image repository
  when: postgres_original_image_repo
  block:
    - name: "Check if '{{ lookup('role_var', '_paths_location', role='postgres') }}' exists"
      ansible.builtin.stat:
        path: "{{ lookup('role_var', '_paths_location', role='postgres') }}"
      register: stat_postgres_path

    - name: "Check if '{{ lookup('role_var', '_paths_location', role='postgres') }}/PG_VERSION' exists"
      ansible.builtin.stat:
        path: "{{ lookup('role_var', '_paths_location', role='postgres') }}/PG_VERSION"
      register: stat_postgres_version_path

    - name: Check for upgrade
      when: stat_postgres_path.stat.exists and stat_postgres_version_path.stat.exists
      block:
        - name: Read PG_VERSION file
          ansible.builtin.slurp:
            src: "{{ lookup('role_var', '_paths_location', role='postgres') }}/PG_VERSION"
          register: pg_version_file

        - name: Define installed and desired Postgres versions
          ansible.builtin.set_fact:
            postgres_major_version: "{{ pg_version_file['content'] | b64decode | trim }}"
            postgres_docker_tag_major_version: "{{ lookup('role_var', '_docker_image_tag', role='postgres').split('-')[0] | regex_replace('^([0-9]+).*', '\\1') }}"

        - name: Display PostgreSQL version
          ansible.builtin.debug:
            msg: "The current PostgreSQL version is {{ postgres_major_version }}"

        - name: Validate Docker tag version
          ansible.builtin.assert:
            that:
              - postgres_docker_tag_major_version is regex("^[0-9]+$")
            fail_msg: "Invalid version specified for 'postgres_docker_image_tag': {{ lookup('role_var', '_docker_image_tag', role='postgres') }}"
            success_msg: "Valid version specified for 'postgres_docker_image_tag': {{ lookup('role_var', '_docker_image_tag', role='postgres') }}"

    - name: Upgrade PostgreSQL
      when: stat_postgres_path.stat.exists and (postgres_major_version != postgres_docker_tag_major_version)
      block:
        - name: Fail if downgrade
          ansible.builtin.fail:
            msg: "Downgrade of PostgreSQL is not supported."
          when: postgres_major_version > postgres_docker_tag_major_version

        - name: Remove existing Docker container
          ansible.builtin.include_tasks: "{{ resources_tasks_path }}/docker/remove_docker_container.yml"

        - name: "Check if '{{ lookup('role_var', '_paths_location', role='postgres') }}_backup' exists"
          ansible.builtin.stat:
            path: "{{ lookup('role_var', '_paths_location', role='postgres') }}_backup"
          register: stat_postgres_backup_path

        - name: Fail if backup location already exists
          ansible.builtin.fail:
            msg:
              - "A backup of the postgres folder already exists, clean it up if it was from a previously successful upgrade. Otherwise ask for help on the discord."
              - "Path is {{ lookup('role_var', '_paths_location', role='postgres') }}_backup"
          when: stat_postgres_backup_path.stat.exists

        - name: Move Postgres data folder
          ansible.builtin.shell: mv "{{ lookup('role_var', '_paths_location', role='postgres') }}" "{{ lookup('role_var', '_paths_location', role='postgres') }}_backup"

        - name: Create directories
          ansible.builtin.include_tasks: "{{ resources_tasks_path }}/directories/create_directories.yml"

        - name: "Create Docker container (Desired tag: {{ lookup('role_var', '_docker_image_tag', role='postgres') }})"
          ansible.builtin.include_tasks: "{{ resources_tasks_path }}/docker/create_docker_container.yml"
          vars:
            postgres_role_docker_container: "{{ postgres_name + '_new' }}"
            postgres_role_docker_networks_alias: "{{ postgres_name + '_new' }}"

        - name: "Create Docker container (Previous tag: {{ postgres_major_version }}-alpine)"
          ansible.builtin.include_tasks: "{{ resources_tasks_path }}/docker/create_docker_container.yml"
          vars:
            postgres_role_docker_container: "{{ postgres_name + '_old' }}"
            postgres_role_docker_networks_alias: "{{ postgres_name + '_old' }}"
            postgres_role_docker_image: "{{ lookup('role_var', '_docker_image_repo', role='postgres')
                                            + ':' + postgres_major_version + '-alpine' }}"
            postgres_role_docker_volumes_default:
              - "{{ postgres_role_paths_location }}_backup:/data"
              - "/etc/passwd:/etc/passwd:ro"

        - name: Sleep for 60 seconds
          ansible.builtin.wait_for:
            timeout: 60

        - name: Perform database migration
          ansible.builtin.shell: |
            set -eo pipefail
            docker exec {{ postgres_name }}_old pg_dumpall | docker exec -i {{ postgres_name }}_new psql -d postgres
          args:
            executable: /bin/bash
          register: postgres_migration_result
          failed_when: false

        - name: Check migration result
          ansible.builtin.fail:
            msg: "Migration failed: {{ postgres_migration_result.stderr }}"
          when: postgres_migration_result.rc != 0

        - name: Update user password for SCRAM authentication in new container
          ansible.builtin.shell: |
            docker exec {{ postgres_name }}_new psql -U {{ lookup('role_var', '_docker_env_user', role='postgres') }} -d {{ lookup('role_var', '_docker_env_db', role='postgres') }} -c "ALTER USER {{ lookup('role_var', '_docker_env_user', role='postgres') }} WITH PASSWORD '{{ lookup('role_var', '_docker_env_password', role='postgres') }}';"
          when: (postgres_major_version | int < 14) and (postgres_docker_tag_major_version | int >= 14)

        - name: Remove temporary containers
          community.docker.docker_container:
            name: "{{ item }}"
            state: absent
            container_default_behavior: compatibility
            stop_timeout: "{{ lookup('role_var', '_docker_stop_timeout', default='180') }}"
            tls_hostname: localhost
          loop:
            - "{{ postgres_name }}_old"
            - "{{ postgres_name }}_new"

        - name: Create Docker container
          ansible.builtin.include_tasks: "{{ resources_tasks_path }}/docker/create_docker_container.yml"

        - name: Sleep for 30 seconds
          ansible.builtin.wait_for:
            timeout: 30

- name: Regular Postgres flow
  when: (not postgres_original_image_repo) or (not stat_postgres_path.stat.exists) or (postgres_major_version == postgres_docker_tag_major_version)
  block:
    - name: Remove existing Docker container
      ansible.builtin.include_tasks: "{{ resources_tasks_path }}/docker/remove_docker_container.yml"

    - name: Create directories
      ansible.builtin.include_tasks: "{{ resources_tasks_path }}/directories/create_directories.yml"

    - name: Create Docker container
      ansible.builtin.include_tasks: "{{ resources_tasks_path }}/docker/create_docker_container.yml"

    - name: Sleep for 30 seconds
      ansible.builtin.wait_for:
        timeout: 30
