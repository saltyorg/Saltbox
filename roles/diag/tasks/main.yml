#########################################################################
# Title:            Saltbox: Diagnose                                   #
# Author(s):        salty                                               #
# URL:              https://github.com/saltyorg/Saltbox                 #
# --                                                                    #
#########################################################################
#                   GNU General Public License v3.0                     #
#########################################################################
---
- name: Cloudflare API lookup
  when: cloudflare_is_enabled
  block:
    - name: Get Cloudflare SSL/TLS mode
      cloudflare_ssl:
        auth_email: "{{ cloudflare.email }}"
        auth_key: "{{ cloudflare.api }}"
        domain: "{{ user.domain }}"
      register: cloudflare_ssl

- name: Gather mount information
  ansible.builtin.setup:
    gather_subset:
      - mounts

- name: Filter mount information
  ansible.builtin.set_fact:
    host_mounts: "{{ host_mounts | default({}) | combine({item.mount: item.fstype}) }}"
  loop: "{{ ansible_mounts }}"

- name: "Diagnose variables"
  ansible.builtin.debug:
    msg: >
      {{
        diagnose_vars | map('regex_replace', '^', '') |
        select('match', '^(?!$)') | list
      }}
